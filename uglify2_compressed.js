magic.Calendar=baidu.lang.createClass(function(e){var t=this;t._options=baidu.object.extend({weekStart:"sun",initDate:baidu.i18n.date.toLocaleDate(new Date),highlightDates:[],disabledDates:[],disabledDayOfWeek:[],language:"zh-CN"},e||{}),t.currentDate=new Date(t._options.initDate),t.selectedDate=new Date(t._options.initDate),t.dayNames=[]},{type:"magic.Calendar",superClass:magic.Base}),magic.Calendar.extend({tplSkeleton:'<div id="#{calendarId}" class="#{calendarClass}"><div id="#{titleId}" class="#{titleClass}"></div><div id="#{tableId}" class="#{tableClass}"></div></div>',tplDate:'<td id="#{id}" class="#{class}" onmouseover="#{mouseover}" onmouseout="#{mouseout}" onclick="#{click}">#{date}</td>',render:function(e){var t=this;"string"===baidu.type(e)&&(e="#"+e),t.container=baidu(e)[0],t._renderSkeleton(),t._renderTitle(),t._renderDateTable(),t._renderNavBtn(),t._bindTable(),t._bindNavBtn(),t._addkeystrokesListener(),t.fire("render")},_rerender:function(){var e=this;e._renderTitle(),e._renderDateTable(),e._bindTable()},_getId:function(e){return this._eid+(void 0===e?"tang_calendar":"tang_calendar_"+e)},_getClass:function(e){return void 0===e?"tang-calendar":"tang-calendar-"+e},_renderSkeleton:function(){var e=this,t=e.container;baidu(t).insertHTML("beforeEnd",baidu.string.format(e.tplSkeleton,{calendarId:e._getId(),calendarClass:e._getClass(),titleId:e._getId("title"),titleClass:e._getClass("title"),tableId:e._getId("table"),tableClass:e._getClass("table")})),e.titleEl=baidu("#"+e._getId("title"))[0],e.tableEl=baidu("#"+e._getId("table"))[0],e.$mappingDom("",baidu("#"+e._getId())[0]),e.$mappingDom("calendar",baidu("#"+e._getId())[0]),e.$mappingDom("title",e.titleEl),e.$mappingDom("table",e.tableEl)},_renderTitle:function(){var e=this,t=e.currentDate,a=t.getFullYear(),n=t.getMonth()+1;e.titleEl.innerHTML=baidu.string.format(baidu.i18n.cultures[e._options.language].calendar.titleNames,{yyyy:a,MM:baidu.i18n.cultures[e._options.language].calendar.monthNamesShort[n-1]})},_renderDateTable:function(){var e=this._getTheadString(),t=this._getTbodyString();this.tableEl.innerHTML='<table border="0" cellpadding="0" cellspacing="0">'+e+t+"</table>"},_renderNavBtn:function(){var e=this,t=baidu("#"+e._getId())[0],a=document,n=a.createElement("div"),i=a.createElement("div"),d=a.createElement("div"),s=a.createElement("div");n.className=e._getClass("prebtn"),i.className=e._getClass("nextbtn"),d.className=e._getClass("yprebtn"),s.className=e._getClass("ynextbtn"),t.appendChild(n),t.appendChild(i),t.appendChild(d),t.appendChild(s),e.preBtn=n,e.nextBtn=i,e.ypreBtn=d,e.ynextBtn=s,e.$mappingDom("premonthbtn",n),e.$mappingDom("nextmonthbtn",i),e.$mappingDom("preyearbtn",d),e.$mappingDom("preyearhbtn",s)},_bindNavBtn:function(){var e,t,a,n,i,d,s,r,o,u=this,l=u.preBtn,c=u.nextBtn,g=u.ypreBtn,b=u.ynextBtn,f=!1;baidu(l).on("click",e=function(){!f&&u.preMonth(),f=!1,u.fire("premonth")}),baidu(c).on("click",t=function(){!f&&u.nextMonth(),f=!1,u.fire("nextmonth")}),baidu(g).on("click",a=function(){!f&&u.preYear(),f=!1,u.fire("preyear")}),baidu(b).on("click",n=function(){!f&&u.nextYear(),f=!1,u.fire("nextyear")});var D=null,_=function(e,t){function a(){D=setTimeout(function(){t?"pre"==e?u.preYear():u.nextYear():"pre"==e?u.preMonth():u.nextMonth(),f=!0,a()},500)}D||a()},h=function(){clearTimeout(D),D=null};baidu(l).on("mousedown",i=function(){_("pre")}),baidu(c).on("mousedown",d=function(){_("next")}),baidu(g).on("mousedown",s=function(){_("pre",!0)}),baidu(b).on("mousedown",r=function(){_("next",!0)}),baidu(document).on("mouseup",o=function(){u.disposed||D&&h()}),u.on("dispose",function(){baidu(l).off("click",e),baidu(c).off("click",t),baidu(g).off("click",a),baidu(b).off("click",n),baidu(l).off("mousedown",i),baidu(c).off("mousedown",d),baidu(g).off("mousedown",s),baidu(b).off("mousedown",r),baidu(document).off("mouseup",o)})},_getTheadString:function(){var e,t=this,a=["mon","tue","wed","thu","fri","sat","sun"],n=[],i=t._options.weekStart.toLowerCase(),d=baidu.array.indexOf(a,i),s=baidu.i18n.cultures[t._options.language].calendar.dayNames,r=0;for(n.push('<thead class="'+t._getClass("weekdays")+'"><tr>');7>r;r++)d>6&&(d=0),t.dayNames.push(a[d]),e=s[a[d]],n.push("<th>"+e+"</th>"),d++;return n.push("</tr></thead>"),n.join("")},_getTbodyString:function(){var e,t=this,a=t.dayNames,n=["sun","mon","tue","wed","thu","fri","sat"],i=new Date(t.currentDate),d=0,s=[],r=baidu.i18n.date.getDaysInMonth(i.getFullYear(),i.getMonth()),o=5,u="",l="";i.setDate(1),e=i.getDay(),d=baidu.array.indexOf(a,n[e]),d+r>35&&(o=6),i.setDate(i.getDate()-d);for(var c=0,g=0,b="";o>c;c++){for(s.push("<tr>");7>g;g++)b=t._getClass("date"),u="",(0==i.getDay()||6==i.getDay())&&(b+=" "+t._getClass("weekend")),t._datesEqual(baidu.i18n.date.toLocaleDate(new Date),i)&&(b+=" "+t._getClass("today")),t._datesContains(t._options.highlightDates,i)&&(b+=" "+t._getClass("highlight")),t._datesContains(t._options.disabledDates,i)&&(b+=" "+t._getClass("disable")),t._dayOfWeekInDisabled(i.getDay())&&(b+=" "+t._getClass("disable")),t._datesEqual(t.selectedDate,i)&&(b+=" "+t._getClass("selected"),u='id="'+t._getId("selected")+'"'),i.getMonth()<t.currentDate.getMonth()||i.getFullYear()<t.currentDate.getFullYear()?b+=" "+t._getClass("premonth"):(i.getMonth()>t.currentDate.getMonth()||i.getFullYear()>t.currentDate.getFullYear())&&(b+=" "+t._getClass("nextmonth")),l=t._formatDate(new Date(i.getFullYear()+"/"+(i.getMonth()+1)+"/"+i.getDate())),s.push("<td "+u+' class="'+b+'" date="'+l+'" onmouseover=baiduInstance("'+t.guid+'")._mouseoverHandler(event) onmouseout=baiduInstance("'+t.guid+'")._mouseoutHandler(event)>'+i.getDate()+"</td>"),i.setDate(i.getDate()+1);s.push("</tr>"),g=0}return"<tbody>"+s.join("")+"</tbody>"},_formatDate:function(e){var t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate();return a=a>=10?a:"0"+a,n=n>=10?n:"0"+n,t+"/"+a+"/"+n},_mouseoverHandler:function(e){var t,a=this;t=baidu.event(e).target,baidu(t).addClass(a._getClass("hover")),a.fire("mouseover",{target:t})},_mouseoutHandler:function(e){var t,a=this;t=baidu.event(e).target,baidu(t).removeClass(a._getClass("hover")),a.fire("mouseout",{target:t})},_bindTable:function(){var e,t,a,n,i,d=this,s=baidu("#"+d._getId("table"))[0].getElementsByTagName("tbody")[0];baidu(s).on("click",i=function(i){if(e=i.target,"TD"==e.tagName.toUpperCase()){t=e.getAttribute("date"),a=new Date(t);var s=d.selectedDate;a.setHours(s.getHours()),a.setMinutes(s.getMinutes()),a.setSeconds(s.getSeconds()),d._datesContains(d._options.disabledDates,a)||d._dayOfWeekInDisabled(a.getDay())||(n=baidu("#"+d._getId("selected"))[0],n&&(n.id="",baidu(n).removeClass(d._getClass("selected"))),e.id=d._getId("selected"),baidu(e).addClass(d._getClass("selected")),t=d._formatDate(a),d.selectedDate=new Date(t),d.fire("selectdate",{date:new Date(t)}))}}),d.on("dispose",function(){baidu(s).off("click",i)})},_addkeystrokesListener:function(){function e(e){e=e||window.event;var t=!0;switch(e.keyCode){case 33:a.preMonth();break;case 34:a.nextMonth();break;case 37:a._preDay();break;case 38:a._preDay();break;case 39:a._nextDay();break;case 40:a._nextDay();break;default:t=!1}t&&e.preventDefault()}var t,a=this,n=!1,i=baidu("#"+a._getId())[0];baidu(document).on("click",t=function(t){if(!a.disposed){var d=t.target;if(baidu.dom.contains(i,d)||d==i){if(n)return;baidu(document).on("keydown",e),n=!0}else baidu(document).off("keydown",e),n=!1}}),a.on("dispose",function(){baidu(document).off("click",t)})},_datesEqual:function(e,t){if("date"==baidu.type(e)&&"date"==baidu.type(t)){var a=e.getFullYear(),n=e.getMonth(),i=e.getDate(),d=t.getFullYear(),s=t.getMonth(),r=t.getDate();return a==d&&n==s&&i==r}},_days:{mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,sun:0},_dayOfWeekInDisabled:function(e){for(var t,a=this._options.disabledDayOfWeek,n=this._days,i=!1,d=0;a.length>d&&(t=a[d],"object"==typeof t?e>=(n[t.start]||0)&&n[t.end]>=e&&(i=!0):n[t]==e&&(i=!0),!i);d++);return i},_datesContains:function(e,t){var a,n=this,i=0,d=e.length;if("date"==baidu.type(t)){for(;d>i;i++)if(a=e[i],baidu.lang.isDate(a)){if(n._datesEqual(a,t))return!0}else if(a.end&&(a.end=new Date(baidu.date.format(a.end,"yyyy/MM/dd")+" 23:59:59")),(!a.start||t.getTime()>=a.start.getTime())&&(!a.end||t.getTime()<=a.end.getTime()))return!0;return!1}},go:function(e,t){var a=this;a.currentDate.setFullYear(e),a.currentDate.setDate(1),t=void 0===t?a.currentDate.getMonth():t-1,a.currentDate.setMonth(t),a._rerender()},getDate:function(){return new Date(this.selectedDate)},setDate:function(e){var t=this,a=new Date(e);if("date"!=baidu.type(e))return!1;if(!t._datesContains(t._options.disabledDates,a)&&!t._dayOfWeekInDisabled(a.getDay()))return t.currentDate=new Date(e),t.selectedDate=new Date(e),t._rerender(),!0},preMonth:function(){var e=this,t=e.currentDate,a=t.getMonth()+1,n=t.getFullYear();e.go(n,a-1)},nextMonth:function(){var e=this,t=e.currentDate,a=t.getMonth()+1,n=t.getFullYear();e.go(n,a+1)},preYear:function(){var e=this,t=e.currentDate;e.go(t.getFullYear()-1,t.getMonth()+1)},nextYear:function(){var e=this,t=e.currentDate;e.go(t.getFullYear()+1,t.getMonth()+1)},_preDay:function(){var e=this,t=new Date(e.selectedDate);t.setDate(t.getDate()-1),e.setDate(t),e.fire("selectdate",{date:t})},_nextDay:function(){var e=this,t=new Date(e.selectedDate);t.setDate(t.getDate()+1),e.setDate(t),e.fire("selectdate",{date:t})},$dispose:function(){var e=this;e.disposed||(e.container.removeChild(baidu("#"+e._getId())[0]),magic.Base.prototype.$dispose.call(e))}});